---
title: "05.2_fit_seabird_model"
author: "Markus Min"
date: "`r Sys.Date()`"
output: html_document
---

This document fits the 05.2_seabird_model, which incorporates the following data sources:

1. JSOES seabird data (for Common Murres and Sooty Shearwaters)
2. JSOES trawl data (for yearling and subyearling Interior Chinook)

The 5.1 model already fits the best fit model for all of the prey items and calculates overlap/indices of abundance - so those metrics can be extracted from that model to be included in the stage 6 model.

```{r load_libraries_source_scripts, include = FALSE}
library(tidyverse)
library(here)
library(TMB)
library(ggforce)
library(sdmTMB)
library(kableExtra)
library(fmesher)
library(ggrepel)
library(mgcv)
library(sf)

# knitr::opts_chunk()

# source the function scripts
source("R/functions/cAIC.R")
source("R/functions/rmvnorm_prec.R")
source("R/functions/sample_var.R")
source("R/functions/plot_anisotropy_MM.R")
source("R/functions/make_anisotropy_spde.R")
source("R/functions/H_matrix_prior_predictive_check_for_ggplot.R")
source("R/functions/plot_distribution.R")
source("R/functions/plot_distribution_PRS_PWCC.R")
source("R/functions/plot_distribution_jsoes_bongo.R")
# source("R/functions/plot_distribution_hake_survey.R")
source("R/functions/generate_prediction_maps.R")
source("R/functions/generate_prediction_maps_PRS_PWCC.R")
source("R/functions/generate_prediction_maps_jsoes_bongo.R")
source("R/functions/generate_prediction_maps_hake_survey.R")
source("R/functions/generate_prediction_maps_cces.R")
source("R/functions/stage2_helper_functions.R")
source("R/functions/sdmTMB_smoothing_functions.R")

# source the prep scripts for each of the surveys
source(here::here("R", "JSOES_seabirds_make_mesh.R"))
source(here::here("R", "JSOES_make_mesh.R"))
```

## Prepare survey data for SDMs

#### CSYIF + CSSIF (JSOES Trawl)
```{r csyif_cssif_data_prep}

#### prep model data ####

# extract Yearling Interior Chinook
csyif <- subset(jsoes_long, species == "chinook_salmon_yearling_interior_fa")
# extract subyearling Interior Chinook
cssif <- subset(jsoes_long, species == "chinook_salmon_subyearling_interior_fa")

#### Create SPDE objects ####

# there are multiple meshes that are created in JSOES_make_mesh.R
# here, we will use the cutoff 15 mesh, although a higher resolution is likely going
# to improve results (at the cost of run time)

trawl_spde <- fm_fem( inla_mesh_cutoff15, 
                      order = 2 )

# create projection matrix from vertices to samples
trawl_is = fm_evaluator(inla_mesh_cutoff15, loc = as.matrix(data.frame(X = csyif$X, Y = csyif$Y)))$proj$A

# create projection matrix from vertices to prediction grid
trawl_gs = fm_evaluator( inla_mesh_cutoff15, loc=st_coordinates(survey_domain_cov_grid))$proj$A

# prep anisotropy input
# note that spatial list replaces the M0, M1, M2 objects 
spatial_list_trawl <- make_anisotropy_spde( inla_mesh_cutoff15 )
```


#### Common Murres + Sooty Shearwaters (JSOES seabirds)

```{r data_prep}
#### prep model data ####
# extract Sooty Shearwaters
sosh <- subset(birds_long, species == "sooty_shearwater")
comu <- subset(birds_long, species == "common_murre")

# generate the projection vector/matrix for covariates - this relies
# on the survey prediction grid from the JSOES_make_mesh.R script

distance_projection_vector <- as.numeric(filter(survey_predict_grid, year == 2010)$dist_shore_scaled)

# for SST - take prediction grid, drop salinity, add SST with locations as rows and years as column
survey_predict_grid %>% 
  # select only the years that we're keeping
  # filter(!(year %in% c(1998, 2022:2025))) %>% 
  filter(year %in% unique(sosh$year)) %>% 
  dplyr::select(-c(SST, dist_shore, dist_shore_scaled)) %>% 
  pivot_wider(names_from = year, values_from = SST_scaled) %>% 
  dplyr::select(-c(X, Y)) %>% 
  as.matrix() -> temperature_projection_matrix
  
# create a second temperature projection grid that contains the missing years
survey_predict_grid_birds_allyears %>% 
  # select only the years that we're keeping
  filter(!(year %in% c(1998, 2022:2025))) %>% 
  dplyr::select(-c(SST, dist_shore, dist_shore_scaled)) %>% 
  pivot_wider(names_from = year, values_from = SST_scaled) %>% 
  dplyr::select(-c(X, Y)) %>% 
  as.matrix() -> temperature_projection_matrix_birds_allyears

#### Create SPDE objects ####

# there are multiple meshes that are created in JSOES_make_mesh.R
# here, we will use the cutoff 15 mesh, although a higher resolution is likely going
# to improve results (at the cost of run time)

### June SPDE objects

birds_spde <- fm_fem( birds_inla_mesh_cutoff15, 
                      order = 2 )

# create projection matrix from vertices to samples
A_is_birds = fm_evaluator(birds_inla_mesh_cutoff15, loc = as.matrix(data.frame(X = comu$X, Y = comu$Y)))$proj$A

# create projection matrix from vertices to prediction grid
A_gs_birds = fm_evaluator( birds_inla_mesh_cutoff15, loc=st_coordinates(survey_domain_cov_grid))$proj$A

# prep anisotropy input
# note that spatial list replaces the M0, M1, M2 objects 
spatial_list_birds <- make_anisotropy_spde( birds_inla_mesh_cutoff15 )
```


# Fit SDM

Export the mesh and projection grid for the supplemental figures
```{r export_mesh_figures}
#### JSOES Seabirds ####

# transform mesh to sf
fm_as_sfc(birds_inla_mesh_cutoff15) %>% 
  st_set_crs(st_crs(UTM_zone_10_crs)) -> birds_inla_mesh_cutoff15_sf

JSOES_seabirds_mesh_plot <- survey_area_basemap_km +
  geom_point(data = subset(survey_predict_grid, year == 2017), aes(x = X, y = Y), color = "gray50", alpha = 0.25) +
  geom_sf(data = birds_inla_mesh_cutoff15_sf, fill = NA, color = "black") +
  geom_point(data = sosh, aes(x = X, y = Y), color = "white",fill = "red", shape = 24, size = 3)

ggsave(here::here("figures", "paper_figures", "mesh_figures", "JSOES_seabirds_mesh_plot.png"), JSOES_seabirds_mesh_plot,  height = 8, width = 4)
```

```{r SDM_inputs_prep}
# create covariate grids for projections
# generate the projection vector/matrix for covariates - this relies
# on the survey prediction grid from the JSOES_make_mesh.R script

distance_projection_vector <- as.numeric(filter(survey_predict_grid, year == 2000)$dist_shore_scaled)

# for SST - take prediction grid, drop salinity, add SST with locations as rows and years as column
survey_predict_grid %>% 
  # select only the years that we're keeping
  filter(!(year %in% c(1998, 2022:2025))) %>% 
  dplyr::select(-c(SST, sal, sal_scaled, dist_shore, dist_shore_scaled)) %>% 
  pivot_wider(names_from = year, values_from = SST_scaled) %>% 
  dplyr::select(-c(X, Y)) %>% 
  as.matrix() -> temperature_projection_matrix


common_years_seabird_model <- intersect(unique(csyif$year), # jsoes trawl
                          unique(comu$year)) # seabird data

# CSYIF
# nothing additional required

# CSSIS
# smoothers
# to get the sdmTMB code to work, you just need to make sure that you provide the smooth terms in a formula (no need to write the complete formula)
sm_cssif <- parse_smoothers(formula = "n_per_km ~ s(dist_shore_scaled)", data = as.data.frame(cssif), knots = NULL)

# get smoother values for predict grid
predict_grid_cssif <- data.frame(SST_scaled = as.vector(temperature_projection_matrix),
                           dist_shore_scaled = rep(distance_projection_vector, ncol(temperature_projection_matrix)))

sm_predict_cssif <- parse_smoothers(formula = "n_per_km ~ s(dist_shore_scaled)", data = as.data.frame(cssif), knots = NULL,
                              newdata = predict_grid_cssif, basis_prev = sm_cssif$basis_out)

# COMU
# nothing additional required

# SOSH
# smoothers
# to get the sdmTMB code to work, you just need to make sure that you provide the smooth terms in a formula (no need to write the complete formula)
sm_sosh <- parse_smoothers(formula = "n_per_km2 ~ s(dist_shore_scaled)", data = as.data.frame(sosh), knots = NULL)

# get smoother values for predict grid
predict_grid_sosh <- data.frame(
  dist_shore_scaled = rep(distance_projection_vector, ncol(temperature_projection_matrix_birds_allyears)))

sm_predict_sosh <- parse_smoothers(formula = "n_per_km2 ~ s(dist_shore_scaled)", data = as.data.frame(sosh), knots = NULL,
                              newdata = predict_grid_sosh, basis_prev = sm_sosh$basis_out)

```

```{r}
# save.image("05.2_seabird_SDM_workspace.rda")
# load("05.2_seabird_SDM_workspace.rda")
compile(here::here("R", "05_stage1_SDM", "05.2_seabird_SDM", "05_2_seabird_SDM_v2.cpp"))
dyn.load(dynlib(here::here("R", "05_stage1_SDM", "05.2_seabird_SDM", "05_2_seabird_SDM_v2")))

seabird_SDM_Data = list(
  ## time series lengths
  "n_t_jsoes" = length(unique(csyif$year)),
  "n_t_shared" = length(common_years_seabird_model),
  "n_t_birds" = max(sosh$year - min(sosh$year))+1,
  # the indices of the different data sources in the common years
  "t_jsoes_indices" = match(common_years_seabird_model, unique(csyif$year))-1,
  "t_birds_indices" = match(common_years_seabird_model, min(sosh$year):max(sosh$year))-1,
  
  # temperature and distance projection matrices
  "temp_gt" = temperature_projection_matrix,
  "dist_g" = distance_projection_vector,
  
  ## csyif data
  "weights_i_csyif" = rep(1, length(csyif$n_per_km)), # weights (all 1)
  "D_i_csyif"= csyif$n_per_km/max(csyif$n_per_km)*1000, "t_i_csyif" =  csyif$year - min(csyif$year),
  "A_is_csyif"=trawl_is, "A_gs_csyif"=trawl_gs, # "M0_b"=trawl_spde$c0, "M1_b"=trawl_spde$g1, "M2_b"=trawl_spde$g2,
  "spatial_list_csyif" = spatial_list_trawl,
  "temp_i_csyif" = csyif$SST_scaled,
  
  ## cssif data
  "weights_i_cssif" = rep(1, length(cssif$n_per_km)), # weights (all 1)
  "D_i_cssif"= cssif$n_per_km/max(cssif$n_per_km)*1000,
  "t_i_cssif" = cssif$year - min(cssif$year),
  "A_is_cssif"=trawl_is, "A_gs_cssif"=trawl_gs, # "M0_b"=trawl_spde$c0, "M1_b"=trawl_spde$g1, "M2_b"=trawl_spde$g2,
  "spatial_list_cssif" = spatial_list_trawl,
  "temp_i_cssif" = cssif$SST_scaled,
  "dist_i_cssif" = cssif$dist_shore_scaled,
  # cssif smooth function data
  "Zs_cssif" = sm_cssif$Zs, # smoother basis function matrices
  "Xs_cssif" = sm_cssif$Xs, # smoother linear effect matrix
  "b_smooth_start_cssif" = sm_cssif$b_smooth_start,
  "proj_Zs_cssif" = sm_predict_cssif$Zs,
  "proj_Xs_cssif" = sm_predict_cssif$Xs,
  
  # comu data
  # weights (all 1)
  "weights_i_comu" = rep(1, length(comu$n_per_km2)),
  # distance data
  "dist_i_comu" = comu$dist_shore_scaled,
  
  # comu data
  "D_i_comu"= comu$n_per_km2/max(comu$n_per_km2)*1000, "t_i_comu" = as.integer(dplyr::dense_rank(comu$year - min(comu$year))-1),
  "A_gs_comu"=A_gs_birds,
  "A_is_comu"=A_is_birds,
  # "M0_b"=birds_spde$c0, "M1_b"=birds_spde$g1, "M2_b"=birds_spde$g2,
  "spatial_list_comu" = spatial_list_birds,
  
  
  # sosh data
  # weights (all 1)
  "weights_i_sosh" = rep(1, length(sosh$n_per_km2)),
  # distance data
  "dist_i_sosh" = sosh$dist_shore_scaled,
  "D_i_sosh"= sosh$n_per_km2/max(sosh$n_per_km2)*1000, "t_i_sosh" = sosh$year - min(sosh$year),
  "year_factor_t_i_sosh" = c(0,1,2,3,4,5,6,7,8,9,-999,-999,10,11,12,13,14), 
  "A_gs_sosh"=A_gs_birds, 
  "A_is_sosh"=A_is_birds,
  # "M0_b"=birds_spde$c0, "M1_b"=birds_spde$g1, "M2_b"=birds_spde$g2,
  "spatial_list_sosh" = spatial_list_birds,
  # sosh smooth function data
  "Zs_sosh" = sm_sosh$Zs, # smoother basis function matrices
  "Xs_sosh" = sm_sosh$Xs, # smoother linear effect matrix
  "b_smooth_start_sosh" = sm_sosh$b_smooth_start,
  proj_Zs_sosh = sm_predict_sosh$Zs,
  proj_Xs_sosh = sm_predict_sosh$Xs
)


seabird_SDM_Params <- list(
  
  ## csyif fixed effects
  "beta_temp_csyif" = 0,
  "ln_tau_omega_csyif"=0,  "ln_tau_epsilon_csyif"=0,
  "ln_kappa_csyif"=0, "ln_phi_csyif" = 0,
  "ln_H_input_csyif" = c(0, 0),
  "finv_power_csyif" = 0,
  
  "logit_rhoE_csyif" = 0,
  
  # csyif random effects
  "omega_s_csyif"=rnorm(nrow(trawl_spde$c0)),
  "epsilon_st_csyif"=matrix(0, nrow=nrow(trawl_spde$c0), ncol=seabird_SDM_Data$n_t_jsoes),
  
  ## cssif fixed effects
  "beta_temp_cssif" = 0,
  "ln_tau_epsilon_cssif"=0,
  "ln_tau_omega_cssif"=0, 
  "ln_kappa_cssif"=0,
  "ln_phi_cssif" = 0,
  "ln_H_input_cssif" = c(0, 0),
  "finv_power_cssif" = 0,
  
  # "logit_rhoE_cssif" = 0,
  
  # cssif random effects
  "omega_s_cssif"=rnorm(nrow(trawl_spde$c0)),
  "epsilon_st_cssif"=matrix(0, nrow=nrow(trawl_spde$c0), ncol=seabird_SDM_Data$n_t_jsoes),
  
  # cssif smooth functions
  "bs_cssif" = rep(0, ncol(sm_cssif$Xs)),
  "b_smooth_cssif" = rep(0, sum(sm_cssif$sm_dims)),
  "ln_smooth_sigma_cssif" = rep(0, length(sm_cssif$sm_dims)),
  
  ## comu fixed effects
  "beta_dist_comu" = 0,
  "ln_tau_epsilon_comu"=0,
  "ln_kappa_comu"=0,
  "ln_phi_comu" = 0,
  "ln_H_input_comu" = c(0, 0),
  "finv_power_comu" = 0,
  
  # comu random effects
  # "omega_s"=rnorm(nrow(birds_spde$c0)),
  "epsilon_st_comu"=matrix(0, nrow=nrow(birds_spde$c0), ncol=seabird_SDM_Data$n_t_shared),
  
  ## sosh fixed effects
  "ln_tau_epsilon_sosh"=0,
  "ln_kappa_sosh"=0,
  "ln_phi_sosh" = 0,
  "finv_power_sosh" = 0,
  "logit_rhoE_sosh" = 0,
  
  # sosh random effects
  # "omega_s"=rnorm(nrow(birds_spde$c0)),
  "epsilon_st_sosh"=matrix(0, nrow=nrow(birds_spde$c0), ncol=seabird_SDM_Data$n_t_birds),
  
  # sosh smooth functions
  bs_sosh = rep(0, ncol(sm_sosh$Xs)),
  b_smooth_sosh = rep(0, sum(sm_sosh$sm_dims)),
  ln_smooth_sigma_sosh = rep(0, length(sm_sosh$sm_dims))
  
  
  
)

seabird_SDM_Obj = MakeADFun( data=seabird_SDM_Data,
                                                parameters=seabird_SDM_Params,
                                                random= c("omega_s_csyif", "epsilon_st_csyif",
                                                          "omega_s_cssif", "epsilon_st_cssif", "b_smooth_cssif",
                                                          "epsilon_st_comu",
                                                          "epsilon_st_sosh", "b_smooth_sosh"),
                                                DLL = "05_2_seabird_SDM_v2")

# Optimize
seabird_SDM_Opt = nlminb( start=seabird_SDM_Obj$par, obj=seabird_SDM_Obj$fn, grad=seabird_SDM_Obj$gr )
# add getJointPrecision for index
seabird_SDM_Opt$SD = sdreport( seabird_SDM_Obj, bias.correct=TRUE, getJointPrecision = TRUE )
seabird_SDM_report = seabird_SDM_Obj$report()

seabird_SDM_output <- list(seabird_SDM_Obj = seabird_SDM_Obj,
                                              seabird_SDM_Opt = seabird_SDM_Opt,
                                              seabird_SDM_report = seabird_SDM_report)

save(seabird_SDM_output,
     file = here::here("R", "05_stage1_SDM", "05.2_seabird_SDM", "seabird_SDM_output.rda"))

```