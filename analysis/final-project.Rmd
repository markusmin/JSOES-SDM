---
title: "FISH 556: Final Project"
author: "Markus Min"
date: "`r Sys.Date()`"
output:
  pdf_document: default
---

## Overview

For this exercise, we will be using the SPDE method to model spatial random variables.


```{r chunk-options, message = FALSE, echo = FALSE, warning = FALSE}
# set chunk options
knitr::opts_chunk$set(message = FALSE, echo = FALSE, warning = FALSE)
```


```{r load-libraries-reformat-data}
library(tidyverse)
library(here)
library(readxl)
library(janitor)
library(sf)
library(sdmTMB)
library(TMB)
library(rnaturalearth)
library(sdmTMBextra)
library(fmesher)

#### Species data ####
jsoes <- clean_names(read_excel(here::here("Data", "Markus_Min_Trawl_CTD_Chl_Nuts_Thorson_Scheuerell_5.2.24_FINAL.xlsx")))

species_column_names <- colnames(jsoes)[32:ncol(jsoes)]

jsoes %>% 
  pivot_longer(., cols = all_of(species_column_names), values_to = "n_per_km", names_to = "species") %>% 
  mutate(n = n_per_km*trawl_dist_km) -> jsoes_long


#### Spatial data ####
usa_spdf <- st_read("/Users/markusmin/Documents/ESA_RF_2021/map_files/USA_adm0.shp")
# load BC
BC_spdf <- st_read("/Users/markusmin/Documents/ESA_RF_2021/map_files/canada/lpr_000b16a_e.shp")
```


## Data preparation for TMB

```{r data_prep}
# Subset data for one species
csyis <- subset(jsoes_long, species == "chinook_salmon_yearling_interior_sp")

# for now, let's drop any data that's missing lat/longs
csyis <- filter(csyis, !(is.na(mid_lat)))

# Add UTM coordinates to get an equal distance projection and get lat/longs
utm_crs <- get_crs(csyis, c("mid_long", "mid_lat")) # check that

csyis <- add_utm_columns(
  csyis,
  ll_names = c("mid_long", "mid_lat"),
  ll_crs = 4326,
  utm_names = c("Lon.km", "Lat.km"),
  utm_crs = utm_crs,
  units = c("km")
)


# Change Lon.km and Lat.km columns to X and Y to avoid problems later
csyis %>% 
  dplyr::rename(X = Lon.km, Y = Lat.km) -> csyis


# quick check
hist(csyis$n_per_km)
summary(csyis$n_per_km)

# Create mesh for SPDE
# Let's make a mesh for the survey area
# Make a big bounding box, from 44 to 48.5 lat, -126 to -123 long, then take difference with land
grid = st_make_grid( st_bbox(c(xmin=-126, xmax=-123, ymin=44, ymax=48.5)), n=c(10,40), crs = "WGS84")
strait = st_make_grid( st_bbox(c(xmin=-124.5, xmax=-123, ymin=47.9375, ymax=48.5)), n=c(5,5), crs = "WGS84")
st_difference(grid, strait) -> survey_grid # remove strait of Juan de Fuca
st_difference(survey_grid, usa_spdf) -> survey_grid # remove land
st_as_sf(survey_grid) -> survey_grid_df # convert sfc_geometry to data.frame

mesh = fm_mesh_2d( st_coordinates(st_centroid(survey_grid_df)), 
                   plot.delay = NULL, 
                   refine = TRUE )

# second attempt at a mesh
inla_mesh <- fmesher::fm_mesh_2d_inla(
  loc = cbind(csyis$X, csyis$Y), # coordinates
  cutoff = 10 # minimum triangle edge length
)


spde <- fm_fem( inla_mesh, 
                order = 2 )

# create projection matrix from vertices to samples
A_is = fm_evaluator(mesh, loc = as.matrix(data.frame(X = csyis$X, Y = csyis$Y)))$proj$A

# create projection matrix from vertices to grid
A_gs = fm_evaluator( mesh, loc=st_coordinates(st_centroid(survey_grid_df)))$proj$A

# Make the sdmTMB mesh
csyis_mesh <- make_mesh(csyis, xy_cols = c("X", "Y"), cutoff = 10)
# plot(csyis_mesh)
# for consistency, use the inla_mesh for all
mesh_sdmTMB <- make_mesh(csyis, xy_cols = c("X", "Y"), mesh = inla_mesh)

# confirm that the meshes used for bespoke TMB and sdmTMB are the same
plot(csyis_mesh)
plot(inla_mesh)
plot(mesh_sdmTMB)
plot(mesh)
# Let's use the inla mesh, it looks most reasonable (and very close to the default sdmTMB make_mesh one)
```




## Models without covariates

The first model that I fit is a model with main effects for space and year. This model assumes that there is an effect of year and an effect of space, but these factors do not interact. This is in effect our null model.

This model has the following equation:

$$
log(d_{s,t}) \sim \beta_t + \omega_s \\
\omega \sim \textrm{MVN}(\textbf{0},\Sigma) \\
$$

Where:
- $s$ is the station
- $t$ is the year
- $d$ is the density of a species caught in a tow
- $\beta_t$ is the median density in year t
- $\omega_s$ is the density for location $s$ relative to the median location that is typical across years
- $\Sigma$ is the spatial variance. Because we are using the SPDE method, $\Sigma$ is $Q_{spde}^{-1}$.


```{r fit-model1-TMB}
compile(here::here("analysis", "jsoes_null_sdm_1.cpp"))
dyn.load( dynlib(here::here("analysis", "jsoes_null_sdm_1")))

Data = list( "D_i"= csyis$n_per_km, "t_i" = csyis$year - min(csyis$year), 
             "n_t" = length(unique(csyis$year)),
             "A_is"=A_is, "A_gs"=A_gs, "M0"=spde$c0, "M1"=spde$g1, "M2"=spde$g2 )
Params = list( "beta_t"=rep(0, length(unique(csyis$year))), "ln_tau"=0, "ln_kappa"=0, 
               "ln_phi" = 0, "finv_power" = 0, "omega_s"=rnorm(nrow(spde$c0)))
null_Obj = MakeADFun( data=Data, parameters=Params, random= c("omega_s"),
                 DLL = "jsoes_null_sdm_1")

# Optimize
null_Opt = nlminb( start=null_Obj$par, obj=null_Obj$fn, grad=null_Obj$gr )
null_Opt$SD = sdreport( null_Obj, bias.correct=TRUE )
null_report = null_Obj$report()
```

```{r fit-model-1-sdmTMB}
# Fit sdmTMB with effect of year and effect of space, no interaction (model 1, null model)
jsoes_null_sdmTMB <- sdmTMB(n_per_km ~ 0 + as.factor(year),
                         data = csyis,
                         mesh = mesh_sdmTMB,
                         time = "year",
                         spatial = "on",
                         spatiotemporal = "off",
                         family = tweedie(link = "log"))
```


```{r plot-model-1-TMB}
# Load Jim's sample_var() function
source("/Users/markusmin/Documents/UW_courses/Spring_2024/FISH556/Spatio-temporal-models-for-ecologists-1.0.0/Shared_functions/sample_var.R")
source("/Users/markusmin/Documents/UW_courses/Spring_2024/FISH556/Spatio-temporal-models-for-ecologists-1.0.0/Shared_functions/rmvnorm_prec.R")

# making plotting grids

# density
# ln_d_gt = ifelse( report$ln_d_gt<max(report$ln_d_gt-log(1e3)), NA, report$ln_d_gt )
ln_d_gt <- null_report$ln_d_gt
grid_density = st_sf(st_as_sfc(survey_grid_df), ln_d_gt=ln_d_gt, crs=st_crs(survey_grid_df) )

# let's confirm that the model is working how it should: Each year should have the same
# spatial patterns, but a different intensity

# Cool! Makes sense
ggplot(grid_density) +
  geom_sf(aes(fill = ln_d_gt.1))

ggplot(grid_density) +
  geom_sf(aes(fill = ln_d_gt.2))

ggplot(grid_density) +
  geom_sf(aes(fill = ln_d_gt.3))

ggplot(grid_density) +
  geom_sf(aes(fill = ln_d_gt.4))

ggplot(grid_density) +
  geom_sf(aes(fill = ln_d_gt.5))
# standard error (currently not working)
# SE_gt = sample_var( var_name="ln_d_gt", n_samples=500, obj=Obj, mu=Obj$env$last.par.best, prec=Opt$SD$jointPrecision )
# SE_gt = ifelse( Report$ln_d_gt<max(Report$ln_d_gt-log(1e3)), NA, SE_gt )
# grid_SE = st_sf(grid, SE_ln_d_gt=SE_gt, crs=st_crs(grid) )

```

```{r plot-model-1-sdmTMB}
# For newdata, use the same survey_grid_df from above
as.data.frame(st_coordinates(st_centroid(survey_grid_df))) -> predict_grid

# add year column for each
predict_grid %>% 
  mutate(year = 1998) -> predict_grid_1998
predict_grid %>% 
  mutate(year = 1999) -> predict_grid_1999

pred.jsoes_null_sdmTMB_1998 = predict(jsoes_null_sdmTMB, newdata = predict_grid_1998, return_tmb_object = FALSE)
pred.jsoes_null_sdmTMB_1999 = predict(jsoes_null_sdmTMB, newdata = predict_grid_1999, return_tmb_object = FALSE)

# This is a workaround to get it into the right format which I think (?) works...?
grid_density_sdmTMB_1998 = st_sf(st_as_sfc(survey_grid_df), est=pred.jsoes_null_sdmTMB_1998$est, crs=st_crs(survey_grid_df) )
grid_density_sdmTMB_1999 = st_sf(st_as_sfc(survey_grid_df), est=pred.jsoes_null_sdmTMB_1999$est, crs=st_crs(survey_grid_df) )



# compare sdmTMB with bespoke TMB implementation
# Plots:
ggplot(grid_density_sdmTMB_1998) +
  geom_sf(aes(fill = est))

ggplot(grid_density_sdmTMB_1999) +
  geom_sf(aes(fill = est))

ggplot(grid_density) +
  geom_sf(aes(fill = ln_d_gt.1))

ggplot(grid_density) +
  geom_sf(aes(fill = ln_d_gt.2))
# Patterns look very similar - but not identical

# Parameter estimates:
jsoes_null_sdmTMB$sd_report
tidy(jsoes_null_sdmTMB, conf.int = TRUE)
tidy(jsoes_null_sdmTMB, "ran_pars", conf.int = TRUE)

  # TMB model parameters: beta_t; ln_tau; ln_kappa; ln_phi; finv_power; omega_s


# ggplot(pred.jsoes_null_sdmTMB,aes(x = X, y = Y, color = est))  +
#   geom_raster() +
#   ggtitle("Null model")
```

```{r model-diagnostics}
csyis$null_resids <- residuals(jsoes_null_sdmTMB)
qqnorm(csyis$null_resids)
qqline(csyis$null_resids)

ggplot(csyis, aes(X, Y, col = null_resids)) +
  scale_colour_gradient2() +
  geom_point() +
  facet_wrap(~year) +
  coord_fixed()

ggplot(subset(csyis, year = 1998), aes(X, Y, col = null_resids)) +
  scale_colour_gradient2() +
  geom_point() +
  coord_fixed()
```


The second model adds a term for a spatio-temporal variable, $\epsilon_{s,t}$.

This model has the following equation:

$$
log(d_{s,t}) \sim \beta_t + \omega_s + \epsilon_{s,t}\\
\omega \sim \textrm{MVN}(\textbf{0},\sigma_\omega^2\textbf{R}_\omega) \\
\epsilon_{t} \sim \textrm{MVN}(\textbf{0},\sigma_\epsilon^2\textbf{R}_\epsilon) \\
$$

Where:
- $s$ is the station
- $t$ is the year
- $d$ is the density of a species caught in a tow
- $\beta_t$ is the median density in year t
- $\omega_s$ is the density for location $s$ relative to the median location that is typical across years
- $\epsilon_{s,t}$ is a spatio-temporal variable that describes the effect of each combination of year and location on density
- $\textbf{R}_\omega$ = $\textbf{R}_\epsilon$ is the spatial correlation. These are the same because the correlation structure is set up using the SPDE method.
- $\sigma_\omega$ is the spatial variance. This is controlled by the parameter $\tau_\omega$ in the SPDE calculation.
- $\sigma_\epsilon$ is the spatio-temporal variance. This is controlled by the parameter $\tau_\epsilon$ in the SPDE calculation.

However, because we are using the SPDE method to model a precision matrix for our grid that will then be shared for both the spatial ($\omega_s$) and spatio-temoral ($\epsilon_{s,t}) terms, $\sigma_\omega^2\textbf{R}_\omega$ =  $\sigma_\epsilon^2\textbf{R}_\epsilon$ = $\Sigma$ = $Q_{spde}^{-1}$.


```{r fit-model2-TMB}
compile(here::here("analysis", "jsoes_st_sdm_3.cpp"))
dyn.load( dynlib(here::here("analysis", "jsoes_st_sdm_3")))

Data = list( "D_i"= csyis$n_per_km, "t_i" = csyis$year - min(csyis$year), 
             "n_t" = length(unique(csyis$year)),
             "A_is"=A_is, "A_gs"=A_gs, "M0"=spde$c0, "M1"=spde$g1, "M2"=spde$g2 )
Params = list( "beta_t"=rep(0, length(unique(csyis$year))), 
               "ln_tau_omega"=0, "ln_tau_epsilon"=0,
               "ln_kappa"=0, "ln_phi" = 0, 
               "finv_power" = 0, "omega_s"=rnorm(nrow(spde$c0)),
               "epsilon_st"=matrix(0, nrow=nrow(spde$c0), ncol=Data$n_t))

st_Obj = MakeADFun( data=Data, parameters=Params, random= c("omega_s", "epsilon_st"),
                 DLL = "jsoes_st_sdm_3")

# Optimize
st_Opt = nlminb( start=st_Obj$par, obj=st_Obj$fn, grad=st_Obj$gr )
# Opt$SD = sdreport( Obj, bias.correct=TRUE )
st_report = st_Obj$report()
```

```{r fit-model-2-sdmTMB}
# Fit sdmTMB with effect of year and effect of space and spatio-temporal effect
jsoes_st_sdmTMB <- sdmTMB(n_per_km ~ 0 + as.factor(year),
                         data = csyis,
                         mesh = mesh_sdmTMB,
                         time = "year",
                         spatial = "on",
                         spatiotemporal = "iid",
                         family = tweedie(link = "log"))
```


The third model now models the spatio-temporal variable, $\epsilon_{s,t}$, as a temporally autocorrelated process.

This model has the following equation:

$$
log(d_{s,t}) \sim \beta_t + \omega_s + \epsilon_{s,t}\\
\omega \sim \textrm{MVN}(\textbf{0},\sigma_\omega^2\textbf{R}_\omega) \\
\epsilon_{t} \sim \textrm{MVN}(\textbf{0},\sigma_\epsilon^2\textbf{R}_\epsilon) \\
$$

Where:
- $s$ is the station
- $t$ is the year
- $d$ is the density of a species caught in a tow
- $\beta_t$ is the median density in year t
- $\omega_s$ is the density for location $s$ relative to the median location that is typical across years
- $\epsilon_{s,t}$ is a spatio-temporal variable that describes the effect of each combination of year and location on density
- $\textbf{R}_\omega$ = $\textbf{R}_\epsilon$ is the spatial correlation. These are the same because the correlation structure is set up using the SPDE method.
- $\sigma_\omega$ is the spatial variance. This is controlled by the parameter $\tau_\omega$ in the SPDE calculation.
- $\sigma_\epsilon$ is the spatio-temporal variance. This is controlled by the parameter $\tau_\epsilon$ in the SPDE calculation.

However, because we are using the SPDE method to model a precision matrix for our grid that will then be shared for both the spatial ($\omega_s$) and spatio-temoral ($\epsilon_{s,t}) terms, $\sigma_\omega^2\textbf{R}_\omega$ =  $\sigma_\epsilon^2\textbf{R}_\epsilon$ = $\Sigma$ = $Q_{spde}^{-1}$.


```{r fit-model3-TMB}
compile(here::here("analysis", "jsoes_stac_sdm.cpp"))
dyn.load( dynlib(here::here("analysis", "jsoes_stac_sdm")))

Data = list( "D_i"= csyis$n_per_km, "t_i" = csyis$year - min(csyis$year), 
             "n_t" = length(unique(csyis$year)),
             "A_is"=A_is, "A_gs"=A_gs, "M0"=spde$c0, "M1"=spde$g1, "M2"=spde$g2 )
Params = list( "beta_t"=rep(0, length(unique(csyis$year))), 
               "ln_tau_omega"=0, "ln_tau_epsilon"=0,
               "ln_kappa"=0, "logit_rhoE" = 0,  "ln_phi" = 0, 
               "finv_power" = 0, "omega_s"=rnorm(nrow(spde$c0)),
               "epsilon_st"=matrix(0, nrow=nrow(spde$c0), ncol=Data$n_t))

stac_Obj = MakeADFun( data=Data, parameters=Params, random= c("omega_s", "epsilon_st"),
                 DLL = "jsoes_stac_sdm")

# Optimize
stac_Opt = nlminb( start=stac_Obj$par, obj=stac_Obj$fn, grad=stac_Obj$gr )
# Opt$SD = sdreport( Obj, bias.correct=TRUE )
stac_report = stac_Obj$report()
```

```{r fit-model-3-sdmTMB}
# Fit sdmTMB with effect of year and effect of space and spatio-temporal effect
jsoes_stac_sdmTMB <- sdmTMB(n_per_km ~ 0 + as.factor(year),
                         data = csyis,
                         mesh = mesh_sdmTMB,
                         time = "year",
                         spatial = "on",
                         spatiotemporal = "ar1",
                         family = tweedie(link = "log"))
```


The fourth model now models the temporal main effect, $\beta_t$, as a temporally autocorrelated process.
```{r fit-model4-TMB}
compile(here::here("analysis", "jsoes_tempac_sdm.cpp"))
dyn.load( dynlib(here::here("analysis", "jsoes_tempac_sdm")))

Data = list( "D_i"= csyis$n_per_km, "t_i" = csyis$year - min(csyis$year), 
             "n_t" = length(unique(csyis$year)),
             "A_is"=A_is, "A_gs"=A_gs, "M0"=spde$c0, "M1"=spde$g1, "M2"=spde$g2 )
Params = list( "beta_t"=rep(0, length(unique(csyis$year))), 
               "ln_tau_omega"=0, "ln_tau_epsilon"=0,
               "ln_kappa"=0, "logit_rhoB" = 0,  "ln_phi" = 0, 
               "finv_power" = 0, "ln_sigmaB" = 0, "omega_s"=rnorm(nrow(spde$c0)),
               "epsilon_st"=matrix(0, nrow=nrow(spde$c0), ncol=Data$n_t))

tempac_Obj = MakeADFun( data=Data, parameters=Params, random= c("omega_s", "epsilon_st", "beta_t"),
                 DLL = "jsoes_tempac_sdm")

# Optimize
tempac_Opt = nlminb( start=tempac_Obj$par, obj=tempac_Obj$fn, grad=tempac_Obj$gr )
# Opt$SD = sdreport( tempac_Obj, bias.correct=TRUE )
tempac_report = tempac_Obj$report()
```

```{r fit-model-4-sdmTMB}
# Fit sdmTMB with effect of year and effect of space and spatio-temporal effect
# jsoes_tempac_sdmTMB <- sdmTMB(n_per_km ~ 0,
#                          data = csyis,
#                          mesh = mesh_sdmTMB,
#                          time = "year",
#                          time_varying = ~ 0 + as.factor(year),
#                          time_varying_type = "ar1",
#                          spatial = "on",
#                          spatiotemporal = "iid",
#                          family = tweedie(link = "log"),
#                          silent = FALSE)
```

The fifth model now models both the spatio-temporal variable, $\epsilon_{s,t}$, and the temporal main effect, $\beta_t$, as temporally autocorrelated processes.


## Models without covariates: Cross-validation


```{r}
# Set up for parallelization
library(future)
plan(multisession, workers = 4)



# Model 1: Null model
sanity(jsoes_null_sdmTMB)
AIC(jsoes_null_sdmTMB)
jsoes_null_sdmTMB_cv <- sdmTMB_cv(n_per_km ~ 0 + as.factor(year),
                         data = csyis,
                         mesh = mesh_sdmTMB,
                         time = "year",
                         spatial = "on",
                         spatiotemporal = "off",
                         family = tweedie(link = "log"),
                         k_folds = 4)


# Model 2: Spatiotemporal, IID
sanity(jsoes_st_sdmTMB)
AIC(jsoes_st_sdmTMB)
jsoes_st_sdmTMB_cv <- sdmTMB_cv(n_per_km ~ 0 + as.factor(year),
                         data = csyis,
                         mesh = mesh_sdmTMB,
                         time = "year",
                         spatial = "on",
                         spatiotemporal = "iid",
                         family = tweedie(link = "log"),
                         k_folds = 4)


# Model 3: Spatiotemporal, AR1
sanity(jsoes_stac_sdmTMB)
AIC(jsoes_stac_sdmTMB)


# Model 4: Spatiotemporal, IID + AR1 for temporal main effect



```


## Predictions + projections

```{r predict-to-grid}
# create base map
survey_area_basemap <- ggplot(usa_spdf) +
  geom_sf() +
  geom_sf(data = BC_spdf) +
  coord_sf(ylim = c(44,48.5),  xlim = c(-126, -123)) +
  ylab("Latitude")+
  xlab("Longitude")+
  theme(plot.background = element_rect(fill = "white"),
        panel.background = element_rect(fill="white", color = "black"),
        panel.border = element_rect(colour = "black", fill=NA, size=1),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = c(0.14, 0.2),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12))

# create new grid
# create a polygon based off the mesh boundaries
# CRS 32610 is UTM zone 10N, which is the UTM zone that corresponds to the survey area
st_as_sf(as.data.frame(mesh_sdmTMB$loc_xy), coords = c("X", "Y"),
         crs = 32610) -> mesh_sf

new_poly <- st_convex_hull(mesh_sf)
plot(new_poly)
st_crs(new_poly)

# remove land from polygon
coast_proj <- sf::st_transform(usa_spdf$geometry, crs = 32610)


poly <- st_difference(new_poly, coast_proj)
st_crs(poly) 
plot(poly)
st_bbox(poly)


# create a grid within the polygon using the raster package
# resolution <- 2000 # poly is in meters; 2000 is pretty fine: 2000m x 2000m = 4 km2
resolution <- 5 # poly is in km I believe; 5 x 5 = 25 km2
r <- raster::raster(as(poly, "Spatial"), resolution = resolution)
rr <- raster::rasterize(as(poly, "Spatial"), r, getCover = TRUE)
plot(rr)

# convert to data frame and calculate grid cell area for each row
grid <- as.data.frame(raster::rasterToPoints(rr))
grid$area <- grid$layer * resolution * resolution # meters squared
grid <- dplyr::filter(grid, area > 0) |> 
  dplyr::select(-layer)

grid %>% 
  dplyr::rename(X = x, Y = y) -> grid

# grid$X <- grid$x / 1000
# grid$Y <- grid$y / 1000
grid$area.km <- grid$area / 1e03


# plot to see a display of grid cell areas coded by color
ggplot(grid, aes(X, Y, colour = area.km)) +
  geom_tile(width = 10, height = 10, fill = NA) + # in meters
  scale_colour_viridis_c(direction = -1) +
  geom_point(size = 0.5) +
  coord_fixed()

grid_yrs <- replicate_df(grid, "year", unique(csyis$year))


# predict to grid using jsoes_st_sdmTMB
predict_st = predict(jsoes_st_sdmTMB, newdata = grid_yrs, return_tmb_object = FALSE)

```

```{r create-map}
survey_area_basemap + 
  # geom_tile(data = predict_st, aes(x = X*1000, y = Y*1000, fill = exp(est))) +
  geom_tile(data = predict_st, aes(x = X, y = Y, fill = exp(est))) +
  scale_fill_viridis_c( trans = "sqrt",
                        # trim extreme high values to make spatial variation more visible
                        na.value = "yellow", limits = c(0, quantile(exp(predict_st$est), 0.995))) +
  facet_wrap(~year) +
  theme_light() +
  labs(fill = "Predicted\nabundance") +
  labs(x = "Longitude", y = "Latitude")+
  ggtitle("Spatiotemporal model, no covariates")
```


## Models with covariates

#### Covariate exploration

Primary candidates for covariates are the following:

- Station depth (stn_depth_m)
- Nautical miles from shore (nmi_from_shore)
- SST (x3m_temp_c)


Future covariates could include many of the other nutrient/chlorophyll information that is also collected
- Chlorophyll (x3m_Chl_ugL)

```{r covariate-exploration}
ggplot(jsoes, aes(x = as.factor(nmi_from_shore), y = chinook_salmon_yearling_interior_sp)) +
         geom_boxplot()

ggplot(jsoes, aes(x = stn_depth_m, y = chinook_salmon_yearling_interior_sp)) +
         geom_point()

ggplot(jsoes, aes(x = x3m_temp_c, y = chinook_salmon_yearling_interior_sp)) +
         geom_point()

# look at correlation between nmi_from_shore and stn_depth_m
ggplot(jsoes, aes(x = nmi_from_shore, y = stn_depth_m)) +
         geom_point()
cor(jsoes$nmi_from_shore, jsoes$stn_depth_m)
# yeah pretty correlated, should probably only choose one.
# I am going to say that for now, I think that we'll include distance from shore,
# since for a pelagic species that seems to make more ecological sense

```



Based on our model selection process for the selection of spatial and temporal effects, we have now added covariates into our best model.


$$
log(d_{s,t}) \sim \beta_t + \textbf{x}_{s,t}\gamma + \omega_s + \epsilon_{s,t} \\
\omega \sim \textrm{MVN}(\textbf{0},\sigma_w^2\textbf{R}_w) \\
\epsilon_t \sim \textrm{MVN}(\textbf{0},\sigma_\epsilon^2\textbf{R}_\epsilon)
$$

Where:
- $s$ is the station
- $t$ is the year
- $d$ is the density of a species caught in a tow
- $\beta_t$ is the median density in year t
- $\textbf{x}_{s,t}$ is the vector of density covariates at station $s$ in year $t$
- $\gamma$ is the vector of parameters describing the effect of density covariates
- $\omega_s$ is the density for location $s$ relative to the median location that is typical across years
- $\epsilon_{s,t}$ is a spatio-temporal variable
- $\sigma_\omega^2$ is the spatial variance
- $\sigma_\epsilon^2$ is the spatio-temporal variance


$\textbf{x}_{s,t}$ includes the following parameters whose effects are described in $\gamma$:
- SST
- more...


## Area-weighted indices of abundance


```{r index_standardization_function}
# here, write a function that generates an index of abundance across our study time period
```

```{r index_standardization_implementation}
# here, generate an index of abundance for our different Genetic Stock groups
```




## Species distribution overlap

Based on our best model, we will apply the local index of collocation metric of predator-prey overlap. This measures the co-occurrence by estimating the correlation of predator and prey densities, and uses the following equation:
$$
\frac{\sum\limits_{i=1}^n (p\_pred_i*p\_prey_i) }{\sqrt{\sum\limits_{i=1}^n p\_pred_i^2 * \sum\limits_{i=1}^n p\_prey_i^2}}

$$

This can also be used to measure competition.





