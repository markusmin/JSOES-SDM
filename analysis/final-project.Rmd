---
title: "FISH 556: Final Project"
author: "Markus Min"
date: "`r Sys.Date()`"
output:
  pdf_document: default
---

## Overview

For this exercise, we will be using the SPDE method to model spatial random variables.


```{r chunk-options, message = FALSE, echo = FALSE, warning = FALSE}
# set chunk options
knitr::opts_chunk$set(message = FALSE, echo = FALSE, warning = FALSE)
```


```{r load-libraries-reformat-data}
library(tidyverse)
library(here)
library(readxl)
library(janitor)
library(sf)
library(sdmTMB)
library(TMB)
library(rnaturalearth)
library(sdmTMBextra)
library(fmesher)

#### Species data ####
jsoes <- clean_names(read_excel(here::here("Data", "Markus_Min_Trawl_CTD_Chl_Nuts_Thorson_Scheuerell_5.2.24_FINAL.xlsx")))

species_column_names <- colnames(jsoes)[32:ncol(jsoes)]

jsoes %>% 
  pivot_longer(., cols = all_of(species_column_names), values_to = "n_per_km", names_to = "species") %>% 
  mutate(n = n_per_km*trawl_dist_km) -> jsoes_long


#### Spatial data ####
usa_spdf <- st_read("/Users/markusmin/Documents/ESA_RF_2021/map_files/USA_adm0.shp")
# load BC
BC_spdf <- st_read("/Users/markusmin/Documents/ESA_RF_2021/map_files/canada/lpr_000b16a_e.shp")
```


## Data preparation for TMB

```{r data_prep}
# Subset data for one species
csyis <- subset(jsoes_long, species == "chinook_salmon_yearling_interior_sp")

# for now, let's drop any data that's missing lat/longs
csyis <- filter(csyis, !(is.na(mid_lat)))

# Change latitude and longitude columns to X and Y to avoid problems later
csyis %>% 
  dplyr::rename(X = mid_long, Y = mid_lat) -> csyis


# quick check
hist(csyis$n_per_km)
summary(csyis$n_per_km)

# Create mesh for SPDE
# Let's make a mesh for the survey area
# Make a big bounding box, from 44 to 48.5 lat, -126 to -123 long, then take difference with land
grid = st_make_grid( st_bbox(c(xmin=-126, xmax=-123, ymin=44, ymax=48.5)), n=c(10,40), crs = "WGS84")
strait = st_make_grid( st_bbox(c(xmin=-124.5, xmax=-123, ymin=47.9375, ymax=48.5)), n=c(5,5), crs = "WGS84")
st_difference(grid, strait) -> survey_grid # remove strait of Juan de Fuca
st_difference(survey_grid, usa_spdf) -> survey_grid # remove land
st_as_sf(survey_grid) -> survey_grid_df # convert sfc_geometry to data.frame

mesh = fm_mesh_2d( st_coordinates(st_centroid(survey_grid_df)), 
                   plot.delay = NULL, 
                   refine = TRUE )

spde <- fm_fem( mesh, 
                order = 2 )

# create projection matrix from vertices to samples
A_is = fm_evaluator(mesh, loc = as.matrix(data.frame(X = csyis$X, Y = csyis$Y)))$proj$A

# create projection matrix from vertices to grid
A_gs = fm_evaluator( mesh, loc=st_coordinates(st_centroid(survey_grid_df)))$proj$A
```




## Models without covariates

The first model that I fit is a model with main effects for space and year. This model assumes that there is an effect of year and an effect of space, but these factors do not interact. This is in effect our null model.

This model has the following equation:

$$
log(d_{s,t}) \sim \beta_t + \omega_s \\
\omega \sim \textrm{MVN}(\textbf{0},\Sigma) \\
$$

Where:
- $s$ is the station
- $t$ is the year
- $d$ is the density of a species caught in a tow
- $\beta_t$ is the median density in year t
- $\omega_s$ is the density for location $s$ relative to the median location that is typical across years
- $\Sigma$ is the spatial variance. Because we are using the SPDE method, $\Sigma$ is $Q_{spde}^{-1}$.


```{r fit-model1-TMB}
compile(here::here("analysis", "jsoes_null_sdm_1.cpp"))
dyn.load( dynlib(here::here("analysis", "jsoes_null_sdm_1")))

Data = list( "D_i"= csyis$n_per_km, "t_i" = csyis$year - min(csyis$year), 
             "n_t" = length(unique(csyis$year)),
             "A_is"=A_is, "A_gs"=A_gs, "M0"=spde$c0, "M1"=spde$g1, "M2"=spde$g2 )
Params = list( "beta_t"=rep(0, length(unique(csyis$year))), "ln_tau"=0, "ln_kappa"=0, 
               "ln_phi" = 0, "finv_power" = 0, "omega_s"=rnorm(nrow(spde$c0)))
Obj = MakeADFun( data=Data, parameters=Params, random= c("omega_s"),
                 DLL = "jsoes_null_sdm_1")

# Optimize
Opt = nlminb( start=Obj$par, obj=Obj$fn, grad=Obj$gr )
Opt$SD = sdreport( Obj, bias.correct=TRUE )
report = Obj$report()
```

```{r fit-model-1-sdmTMB}
csyis_mesh <- make_mesh(csyis, xy_cols = c("X", "Y"), cutoff = 0.1)
# plot(csyis_mesh)
# for consistency, use the same mesh created above
mesh_sdmTMB <- make_mesh(csyis, xy_cols = c("X", "Y"), mesh = mesh)

# confirm that the meshes used for bespoke TMB and sdmTMB are the same
plot(csyis_mesh)
plot(mesh_sdmTMB)
plot(mesh)
# They look too fine compared to the one created by sdmTMB by default...

# Fit sdmTMB with effect of year and effect of space, no interaction (model 1, null model)
jsoes_null_sdmTMB <- sdmTMB(n_per_km ~ 0 + as.factor(year),
                         data = csyis,
                         mesh = mesh_sdmTMB,
                         time = "year",
                         spatial = "on",
                         spatiotemporal = "off",
                         family = tweedie(link = "log"))
```


```{r plot-model-1-TMB}
# Load Jim's sample_var() function
source("/Users/markusmin/Documents/UW_courses/Spring_2024/FISH556/Spatio-temporal-models-for-ecologists-1.0.0/Shared_functions/sample_var.R")
source("/Users/markusmin/Documents/UW_courses/Spring_2024/FISH556/Spatio-temporal-models-for-ecologists-1.0.0/Shared_functions/rmvnorm_prec.R")

# making plotting grids

# density
# ln_d_gt = ifelse( report$ln_d_gt<max(report$ln_d_gt-log(1e3)), NA, report$ln_d_gt )
ln_d_gt <- report$ln_d_gt
grid_density = st_sf(st_as_sfc(survey_grid_df), ln_d_gt=ln_d_gt, crs=st_crs(survey_grid_df) )

# let's confirm that the model is working how it should: Each year should have the same
# spatial patterns, but a different intensity

# Cool! Makes sense
ggplot(grid_density) +
  geom_sf(aes(fill = ln_d_gt.1))

ggplot(grid_density) +
  geom_sf(aes(fill = ln_d_gt.2))

ggplot(grid_density) +
  geom_sf(aes(fill = ln_d_gt.3))

ggplot(grid_density) +
  geom_sf(aes(fill = ln_d_gt.4))

ggplot(grid_density) +
  geom_sf(aes(fill = ln_d_gt.5))
# standard error (currently not working)
# SE_gt = sample_var( var_name="ln_d_gt", n_samples=500, obj=Obj, mu=Obj$env$last.par.best, prec=Opt$SD$jointPrecision )
# SE_gt = ifelse( Report$ln_d_gt<max(Report$ln_d_gt-log(1e3)), NA, SE_gt )
# grid_SE = st_sf(grid, SE_ln_d_gt=SE_gt, crs=st_crs(grid) )

```

```{r plot-model-1-sdmTMB}
# For newdata, use the same survey_grid_df from above
as.data.frame(st_coordinates(st_centroid(survey_grid_df))) -> predict_grid

# add year column for each
predict_grid %>% 
  mutate(year = 1998) -> predict_grid_1998
predict_grid %>% 
  mutate(year = 1999) -> predict_grid_1999

pred.jsoes_null_sdmTMB_1998 = predict(jsoes_null_sdmTMB, newdata = predict_grid_1998, return_tmb_object = FALSE)
pred.jsoes_null_sdmTMB_1999 = predict(jsoes_null_sdmTMB, newdata = predict_grid_1999, return_tmb_object = FALSE)

# This is a workaround to get it into the right format which I think (?) works...?
grid_density_sdmTMB_1998 = st_sf(st_as_sfc(survey_grid_df), est=pred.jsoes_null_sdmTMB_1998$est, crs=st_crs(survey_grid_df) )
grid_density_sdmTMB_1999 = st_sf(st_as_sfc(survey_grid_df), est=pred.jsoes_null_sdmTMB_1999$est, crs=st_crs(survey_grid_df) )



# compare sdmTMB with bespoke TMB implementation
# Plots:
ggplot(grid_density_sdmTMB_1998) +
  geom_sf(aes(fill = est))

ggplot(grid_density_sdmTMB_1999) +
  geom_sf(aes(fill = est))

ggplot(grid_density) +
  geom_sf(aes(fill = ln_d_gt.1))

ggplot(grid_density) +
  geom_sf(aes(fill = ln_d_gt.2))
# Patterns look very similar - but not identical

# Parameter estimates:
jsoes_null_sdmTMB$sd_report
tidy(jsoes_null_sdmTMB, conf.int = TRUE)
tidy(jsoes_null_sdmTMB, "ran_pars", conf.int = TRUE)
report

  # TMB model parameters: beta_t; ln_tau; ln_kappa; ln_phi; finv_power; omega_s


# ggplot(pred.jsoes_null_sdmTMB,aes(x = X, y = Y, color = est))  +
#   geom_raster() +
#   ggtitle("Null model")
```

```{r model-diagnostics}
csyis$null_resids <- residuals(jsoes_null_sdmTMB)
qqnorm(csyis$null_resids)
qqline(csyis$null_resids)

ggplot(csyis, aes(X, Y, col = null_resids)) +
  scale_colour_gradient2() +
  geom_point() +
  facet_wrap(~year) +
  coord_fixed()

ggplot(subset(csyis, year = 1998), aes(X, Y, col = null_resids)) +
  scale_colour_gradient2() +
  geom_point() +
  coord_fixed()
```


The second model adds a term for a spatio-temporal variable, $\epsilon_{s,t}$.



The third model now models the spatio-temporal variable, $\epsilon_{s,t}$, as a temporally autocorrelated process.


## Models with covariates

Based on our model selection process for the selection of spatial and temporal effects, we have now added covariates into our best model.

The third, and most complex spatio-temporal model, is a model where we have all of the elements of the second model, but now with covariates included.

$$
log(d_{s,t}) \sim \beta_t + \textbf{x}_{s,t}\gamma + \omega_s + \epsilon_{s,t} \\
\omega \sim \textrm{MVN}(\textbf{0},\sigma_w^2\textbf{R}_w) \\
\epsilon_t \sim \textrm{MVN}(\textbf{0},\sigma_\epsilon^2\textbf{R}_\epsilon)
$$

Where:
- $s$ is the station
- $t$ is the year
- $d$ is the density of a species caught in a tow
- $\beta_t$ is the median density in year t
- $\textbf{x}_{s,t}$ is the vector of density covariates at station $s$ in year $t$
- $\gamma$ is the vector of parameters describing the effect of density covariates
- $\omega_s$ is the density for location $s$ relative to the median location that is typical across years
- $\epsilon_{s,t}$ is a spatio-temporal variable
- $\sigma_\omega^2$ is the spatial variance
- $\sigma_\epsilon^2$ is the spatio-temporal variance


$\textbf{x}_{s,t}$ includes the following parameters whose effects are described in $\gamma$:
- SST
- more...

### bespoke TMB implementation
```{r}


set.seed(556)


```



### sdmTMB package implementation






