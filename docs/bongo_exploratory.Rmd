---
title: "JSOES Bongo Data Exploratory Analysis"
author: "Markus Min"
date: "`r Sys.Date()`"
output:
  html_document
---
```{r, echo = FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

This page contains exploratory analysis for the Bongo net data from [JSOES](https://markusmin.github.io/JSOES-SDM/jsoes_survey_description.html). Please note that because the Bongo net tows occur during daylight hours, the tow composition is biased towards taxa/life stages that do not vertically migrate. While different life stages of some species are counted separately for this data, for this exploratory analysis we summed abundances across life stages. 

In this document, I will characterize general patterns in this dataset, and then visualize some key groups of salmon forage that are caught in this survey. This document also contains the scripts to export these groups, formatted for inclusion in the model.

## Data Overview

We will first explore the most common and most abundant taxa in this dataset.


```{r load_libraries_data}
library(readxl)
library(here)
library(janitor)
library(tidyverse)
library(kableExtra)
library(sf)
library(gstat)
library(sp)
library(ggthemes)
library(ape)


bongo <- clean_names(read_excel(here::here("Data", "Markus_Min_Plankton Density for Trophic Summary Query_10.11.24.xlsx")))
# Drop any samples that don't have spatial data
filter(bongo, !(is.na(dec_long))) -> bongo
# this drops one sample: 062904NH30 (NH30 in June 2004)

# turn this into an sf object
st_as_sf(bongo, coords = c("dec_long", "dec_lat"), crs = 4326) -> bongo_sf

# change CRS to UTM zone 10 (to work in meters)
UTM_zone_10_crs <- 32610
bongo_sf_proj <- sf::st_transform(bongo_sf, crs = UTM_zone_10_crs)

# make this projection into kilometers to help with interpretability
bongo_sf_proj_km <- st_as_sf(bongo_sf_proj$geometry/1000, crs = UTM_zone_10_crs)

# extract geometry
as.data.frame(st_coordinates(bongo_sf_proj_km)) -> bongo_km
# add this back to bongo (X and Y now represent eastings and northings in km)
bind_cols(bongo, bongo_km) -> bongo

trophic_groupings <- clean_names(read_excel(here::here("Data", "Markus_Min_Trophic Groupings_10.2.24.xlsx")))

# change genus species to be consistent across these two files, and usual 
# latin name and common name capitalization
bongo$genus_species <- str_to_sentence(bongo$genus_species)
trophic_groupings$genus_species <- str_to_sentence(trophic_groupings$genus_species)
trophic_groupings$common_name <- str_to_title(trophic_groupings$common_name)

trophic_groupings %>% 
  dplyr::select(genus_species, common_name) %>% 
  filter(!(duplicated(genus_species))) -> common_name_df

# get all unique tows
bongo %>% 
  mutate(sampleID = paste0(station, "_", sample_date)) %>% 
  relocate(sampleID) %>% 
  dplyr::select(-c(genus_species, life_history_stage, id_code, count, sum_of_density_number_m3)) %>% 
  filter(!(duplicated(sampleID))) -> bongo_tows

# complete bongo data, so that we have zeros for each taxon in tows where they weren't caught
bongo %>% 
  mutate(sampleID = paste0(station, "_", sample_date)) %>% 
  relocate(sampleID) %>% 
  # drop tow information; we will add this back later
  dplyr::select(-c(id_code, cruise_number, month, year, station_code, net_type, sample_date,
           sample_time, dec_lat, dec_long, station_depth_m, transect_name, station_number, 
           station, n_cr_s, day_night, volume_filtered_m3)) %>% 
  complete(sampleID, 
           nesting(genus_species, life_history_stage), 
           fill = list(count = 0, sum_of_density_number_m3 = 0)) -> bongo_catch

bongo_catch %>% 
  left_join(bongo_tows, by = "sampleID") -> bongo_catch





# add common name
bongo_catch %>% left_join(common_name_df, by = "genus_species") -> bongo_catch

# create a version of this where we collapse all life history stages together
bongo_catch %>% 
  dplyr::select(sampleID, genus_species, count, sum_of_density_number_m3) %>% 
  group_by(sampleID, genus_species) %>% 
  summarise_if(is.numeric, sum) -> bongo_catch_LH_collapse

bongo_catch_LH_collapse %>% 
  left_join(bongo_tows, by = "sampleID") %>% 
  ungroup() -> bongo_catch_LH_collapse
```

```{r load_spatial_data, cache = TRUE}
#### Spatial data ####
usa_spdf <- st_read("/Users/markusmin/Documents/ESA_RF_2021/map_files/USA_adm0.shp", quiet = TRUE)
# load BC
CAN_spdf <- st_read("/Users/markusmin/Documents/ESA_RF_2021/map_files/canada/lpr_000b16a_e.shp", quiet = TRUE)
BC_spdf <- filter(CAN_spdf, PRENAME == "British Columbia")
BC_proj <- st_transform(BC_spdf, crs = 4326)


# crop them to our desired area
US_west_coast <- sf::st_crop(usa_spdf,
    c(xmin = -126, ymin = 44, xmax = -123, ymax = 48.5))

BC_coast <- sf::st_crop(BC_proj,
    c(xmin = -126, ymin = 44, xmax = -123, ymax = 48.5))



# convert both shapefiles to a different projection (UTM zone 10) so that they can be plotted with the sdmTMB output
UTM_zone_10_crs <- 32610

US_west_coast_proj <- sf::st_transform(US_west_coast, crs = UTM_zone_10_crs)
BC_coast_proj <- sf::st_transform(BC_coast, crs = UTM_zone_10_crs)

# make this projection into kilometers
US_west_coast_proj_km <- st_as_sf(US_west_coast_proj$geometry/1000, crs = UTM_zone_10_crs)
BC_coast_proj_km <- st_as_sf(BC_coast_proj$geometry/1000, crs = UTM_zone_10_crs)
```



```{r common_taxa}
## total density
bongo_catch %>% 
  group_by(genus_species) %>% 
  summarise(mean_density_per_m3 = mean(sum_of_density_number_m3),
            sd_density_per_m3 = sd(sum_of_density_number_m3)) %>% 
  arrange(desc(mean_density_per_m3)) %>% 
  left_join(common_name_df, by = "genus_species") %>% 
  relocate(common_name, .after = "genus_species") -> bongo_catch_density_sums

bongo_catch_density_sums[1:10,] %>% 
  mutate(mean_density_per_m3 = round(mean_density_per_m3, 1),
         sd_density_per_m3 = round(sd_density_per_m3, 1)) %>% 
  kbl(caption = "Top ten taxa by mean density.") %>% 
  kable_styling(latex_options = "HOLD_position")

## frequency of occurrence

# get count of each genus_species
bongo_catch_LH_collapse %>% 
  filter(sum_of_density_number_m3 > 0) %>% 
  count(genus_species) %>% 
  arrange(desc(n)) %>% 
  mutate(prop_samples = n/nrow(bongo_tows)) %>% 
  left_join(common_name_df, by = "genus_species") %>% 
  relocate(common_name, .after = "genus_species") -> bongo_freq_occ

bongo_freq_occ[1:10, c("genus_species", "common_name", "prop_samples")] %>% 
  mutate(prop_samples = round(prop_samples, 2)) %>% 
  kbl(caption = "Top ten taxa by frequency of occurrence.") %>% 
  kable_styling(latex_options = "HOLD_position")

```


```{r create_basemap, cache = TRUE}
# create base map
survey_area_basemap_km <- ggplot(US_west_coast_proj_km) +
  geom_sf() +
  geom_sf(data = BC_coast_proj_km) +
  # coord_sf(ylim = c(4922.052, 5342.052), xlim = c(334.8638, 404.8638)) +
  # coord_sf(ylim = c(44,48.5),  xlim = c(-126, -123)) +
  ylab("Latitude")+
  xlab("Longitude")+
  theme(plot.background = element_rect(fill = "white"),
        panel.background = element_rect(fill="white", color = "black"),
        panel.border = element_rect(colour = "black", fill=NA, size=1),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = c(0.14, 0.2),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12),
        axis.ticks = element_blank(),
        axis.text = element_blank())
  # temporary fix for lat/long on axes to just get rid of them - start here to actually fix: https://forum.posit.co/t/converting-axes-to-lat-lon/27181

survey_area_basemap <- ggplot(US_west_coast) +
  geom_sf() +
  geom_sf(data = BC_coast) +
  coord_sf(ylim = c(44,48.5),  xlim = c(-126, -123)) +
  scale_x_continuous(breaks = c(124,125,126)) +
  ylab("Latitude")+
  xlab("Longitude")+
  theme(plot.background = element_rect(fill = "white"),
        panel.background = element_rect(fill="white", color = "black"),
        panel.border = element_rect(colour = "black", fill=NA, size=1),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = c(0.14, 0.2),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12))
```


```{r plot-taxon-distribution}
plot_distribution <- function(data, taxon_name){
  # create facet_wrap plot for distribution across all years
  data %>% 
    mutate(encounter = ifelse(sum_of_density_number_m3 == 0, "zero", "non-zero")) %>% 
    dplyr::rename("density (N/m3)" = sum_of_density_number_m3) -> data
  
  survey_area_basemap +
      geom_point(data = data, aes(x = dec_long, y = dec_lat, size = `density (N/m3)`, color = encounter),
                 alpha = 0.5) +
    scale_color_manual(values = c("zero" = "#fc9272", "non-zero" = "#2ca25f")) +
    facet_wrap(~year, nrow = 3) +
    ggtitle(taxon_name) +
    theme(legend.position = c(0.9, 0.15),
        legend.key.height = unit(0.35, "cm"),
        legend.key.width = unit(0.25, "cm"),
        legend.title = element_text(size = 8),
        legend.text = element_text(size = 6),
        legend.spacing.y = unit(0.01, 'cm')) -> species_distribution_plot
  
  return(species_distribution_plot)
}
```
## Annual time series

This Shiny app can be used to explore the abundances of different taxa across the full length of the time series. In this Shiny app, I take the mean log density across the survey region to create a simple index of abundance.

```{r}
knitr::include_app(url = "https://markusmin.shinyapps.io/jsoes_bongo_annual_time_series/", height = "700px")
# <iframe src="https://markusmin.shinyapps.io/jsoes_bongo_annual_time_series/" style="border:none;width:1000px;height:500px;"></iframe>
```


## Exploring broad groups of taxa

The JSOES bongo data contains data on both the direct prey of Pacific salmon as well as the prey items of the prey of Pacific salmon. The direct salmon prey that is caught in this survey includes Euphausiids, Cancer crab larvae, hyperiid amphipods, and non-cancer crab larvae. The abundance of copepods has also been correlated with salmon marine survival, and as such we will also examine these taxa.

Let's ID everything that's seen in at least 0.5% of samples. This accounts for 118 of 215 total taxa identified in this survey.

```{r}
# bongo_taxon_groups <- data.frame(genus_species = bongo_freq_occ$genus_species,
#                                  group = c(
#   "krill", "krill", "krill",
#   "cold-water copepod", "Cancer crab larvae", "Chaetognaths",
#   "Hyperiid amphipod", "Barnacle larvae", "sea butterflies",
#   "Crangon shrimp", "Hyperiid amphipod", "fish eggs",
#   "Caridean shrimp", "Cnidarians", "copepod",
#   "warm-water copepod", "rockfishes", "northern anchovy",
#   "ghost shrimp", "Non-Cancer crab larvae", "Cancer crab larvae",
#   "copepod", "Non-Cancer crab larvae", "Non-Cancer crab larvae",
#   "Gammarid amphipod", "Non-Cancer crab larvae", "Cnidarians",
#   "Cnidarians", "Cancer crab larvae", "Cnidarians",
#   "Barnacle larvae", "copepod", "Non-Cancer crab larvae",
#   "Cnidarians", "Hyperiid amphipod", "flatfishes",
#   "Polychaetes", "Caridean shrimp", "squat lobster",
#   "insects", "myctophids", "flatfishes",
#   "flatfishes", "sculpins", "flatfishes",
#   "Non-Cancer crab larvae", "fishes", "squids",
#   "Gammarid amphipod", "Osmerids", "Non-Cancer crab larvae",
#   "Non-Cancer crab larvae", "mysids", "Pacific Tomcod",
#   "Hyperiid amphipod", "sea butterflies", "sculpins",
#   "Non-Cancer crab larvae", "copepod", "flatfishes", 
#   "Non-Cancer crab larvae", "krill", "shrimp larvae",
#   "snailfishes", "insects", "ronquil/prickleback",
#   "sea butterflies", "Non-Cancer crab larvae", "snailfishes",
#   "snailfishes", "sculpins", "salps",
#   "Hyperiid amphipod", "flatfishes", "salps",
#   
#   "snailfishes", "isopods", "goby",
#   "Hyperiid amphipod", "snailfishes", "Cnidarians",
#   
#   "rockfishes", "sculpins", "bivalves",
#   "Non-Cancer crab larvae", "insects", "myctophids",
#   "Gammarid amphipod", rep(NA, 127)
# ))


bongo_taxon_groups <- data.frame(genus_species = bongo_freq_occ$genus_species,
                                 group = c(
  "krill", "krill", "krill",
  "cold-water copepod", "Cancer crab larvae", "Chaetognaths",
  "Hyperiid amphipod", "Barnacle larvae", "sea butterflies",
  "Crangon shrimp", "Hyperiid amphipod", "fish eggs",
  "Caridean shrimp", "Cnidarians", "copepod",
  "warm-water copepod", "rockfishes", "northern anchovy",
  "ghost shrimp", "Non-Cancer crab larvae", "Cancer crab larvae",
  "copepod", "Non-Cancer crab larvae", "Non-Cancer crab larvae",
  "Gammarid amphipod", "Non-Cancer crab larvae", "Cnidarians",
  "Cnidarians", "Cancer crab larvae", "Cnidarians",
  "Barnacle larvae", "copepod", "Non-Cancer crab larvae",
  "Cnidarians", "Hyperiid amphipod", "flatfishes",
  "Polychaetes", "Caridean shrimp", "squat lobster",
  "insects", "myctophids", "flatfishes",
  "flatfishes", "sculpins", "flatfishes",
  "Non-Cancer crab larvae", "fishes", "squids",
  "Gammarid amphipod", "Osmerids", "Non-Cancer crab larvae",
  "Non-Cancer crab larvae", "mysids", "Pacific Tomcod",
  "Hyperiid amphipod", "sea butterflies", "sculpins",
  "Non-Cancer crab larvae", "copepod", "flatfishes", 
  "Non-Cancer crab larvae", "krill", "shrimp larvae",
  "snailfishes", "insects", "ronquil/prickleback",
  "sea butterflies", "Non-Cancer crab larvae", "snailfishes",
  "snailfishes", "sculpins", "salps",
  "Hyperiid amphipod", "flatfishes", "salps",
  
  "snailfishes", "isopods", "goby",
  "Hyperiid amphipod", "snailfishes", "Cnidarians",
  
  "rockfishes", "sculpins", "bivalves",
  "Non-Cancer crab larvae", "insects", "myctophids",
  "Gammarid amphipod", "insects", "mysids",
  "flatfishes", "copepods", "insects",
  "goby", "sculpins", "shrimp",
  "Cnidarians", "sculpins", "mysids",
  "mysids", "Hyperiid amphipod", "Non-Cancer crab larvae",
  "Pacific sardine", "myctophid", "mysids",
  "sculpins", "Cnidarians", "Caprellid amphipod",
  "sculpins", "unknown decapod", "fish",
  "Non-Cancer crab larvae", "mysids", "Cnidarians",
  "siphonophores", "insects", "Hyperiid amphipod",
  "Cnidarians", rep(NA, 97)
))

# combine the shrimps together
bongo_taxon_groups %>% 
  mutate(group = ifelse(grepl("shrimp|mysids", group), "shrimp larvae", group)) -> bongo_taxon_groups


# bongo_taxon_groups
# table(bongo_taxon_groups$group)
# subset(bongo_taxon_groups, group == "copepod")
# some copepods are not noted as being cold or warm water copepods in the literature,
# but since we are focused on direct prey of salmon we won't worry about this for now
```

## Plotting distributions of some common taxa

Let's visualize the following groups for our study, since they are known direct prey items of salmon:

- Cancer crab larvae
- Non-cancer crab larvae
- shrimp larvae
- Hyperiid amphipods

Krill are also consumed by salmon, but we have other surveys that provide better estimates of krill abundance.

```{r map_groups}
bongo_catch_LH_collapse %>% 
  left_join(bongo_taxon_groups, by = "genus_species") -> bongo_catch_LH_collapse

# create a new function to plot a group
plot_group_distribution <- function(data, group_name){
    # keep only this taxon
  group_data <- subset(data, group == group_name)
  
  # collapse by this group - also collapse all maturity stages.
  # we may not want to do this in the future but for now it's okay
  group_data %>%
    group_by(across(c(-genus_species, -count, -sum_of_density_number_m3))) %>%
    summarise(total_sum_of_density_number_m3 = sum(sum_of_density_number_m3)) -> group_data
  
  # create facet_wrap plot for distribution across all years
  group_data %>% 
    mutate(encounter = ifelse(total_sum_of_density_number_m3 == 0, "zero", "non-zero")) -> group_data
  
  
  # create facet_wrap plot for distribution across all years
  group_data %>% 
    mutate(encounter = ifelse(total_sum_of_density_number_m3 == 0, "zero", "non-zero")) %>% 
    dplyr::rename("total density (N/m3)" = total_sum_of_density_number_m3) -> group_data
  
  survey_area_basemap +
      geom_point(data = group_data, aes(x = dec_long, y = dec_lat, size = `total density (N/m3)`, color = encounter),
                 alpha = 0.5) +
    scale_color_manual(values = c("zero" = "#fc9272", "non-zero" = "#2ca25f")) +
    facet_wrap(~year, nrow = 3) +
    ggtitle(group_name) +
    theme(legend.position = c(0.9, 0.15),
        legend.key.height = unit(0.35, "cm"),
        legend.key.width = unit(0.25, "cm"),
        legend.title = element_text(size = 8),
        legend.text = element_text(size = 6),
        legend.spacing.y = unit(0.01, 'cm')) -> species_distribution_plot
  
  return(species_distribution_plot)
}

cancer_dist_plot <- plot_group_distribution(data = bongo_catch_LH_collapse, group_name = "Cancer crab larvae")

noncancer_dist_plot <- plot_group_distribution(data = bongo_catch_LH_collapse, group_name = "Non-Cancer crab larvae")

shrimp_larvae_dist_plot <- plot_group_distribution(data = bongo_catch_LH_collapse, group_name = "shrimp larvae")

hyperiid_dist_plot <- plot_group_distribution(data = bongo_catch_LH_collapse, group_name = "Hyperiid amphipod")

cancer_dist_plot
noncancer_dist_plot
shrimp_larvae_dist_plot
hyperiid_dist_plot
```

## Lower trophic levels

While we visualize the direct forage of juvenile salmon above, the Bongo data also helps us characterize the distributions and abundance of taxa that are 2+ trophic levels below salmon (i.e., the prey of salmon prey). The literature suggests that the most important of these are copepods, as the abundance of cold-water vs. warm-water copepods has been linked with marine survival. Below, I provide static maps of two focal taxa for this survey:  *Calanus marshallae* (an abundant cold-water copepod) and *Calanus pacificus* (an abundant warm-water coepod).

```{r map_calanus, cache = TRUE}
cama_dist_plot <- plot_distribution(data = subset(bongo_catch_LH_collapse, genus_species == "Calanus marshallae"),
                                    taxon_name = "Calanus marshallae")


ggsave(here::here("docs", "figures", "jsoes_bongo_exploratory", "cama_dist_plot.png"), plot = cama_dist_plot, height = 12, width = 17)


capa_dist_plot <- plot_distribution(data = subset(bongo_catch_LH_collapse, genus_species == "Calanus pacificus"),
                                    taxon_name = "Calanus pacificus")


ggsave(here::here("docs", "figures", "jsoes_bongo_exploratory", "capa_dist_plot.png"), plot = capa_dist_plot, height = 12, width = 17)

# print maps for website
cama_dist_plot
capa_dist_plot

```

```{r calanus_time_series}
create_time_series <- function(data, taxon){
  data %>% 
    mutate(log_density = log(sum_of_density_number_m3 + 1)) %>% 
    group_by(year) %>% 
    summarise(mean_density = mean(log_density),
              sd_density = sd(log_density)) %>% 
    # mutate(CI_95_upper = mean_density + 1.96*sd_density) %>% 
    # mutate(CI_95_lower = mean_density - 1.96*sd_density) %>% 
    mutate(taxon = taxon) -> ts
  
  return(ts)
}

create_time_series(data = subset(bongo_catch_LH_collapse, genus_species == "Calanus marshallae"),
                                 taxon = "Calanus marshallae") -> cama_ts
create_time_series(data = subset(bongo_catch_LH_collapse, genus_species == "Calanus pacificus"),
                   taxon = "Calanus pacificus") -> capa_ts

cama_ts %>% 
  bind_rows(., capa_ts) -> calanus_ts
```

## Export data

In the last section of this script, we will export the following functional groups for inclusion in spatiotemporal models. The data will be formatted as the total density of each functional group at each station.

- Cancer crab larvae
- Non-cancer crab larvae
- shrimp larvae
- Hyperiid amphipods

```{r}
export_group_data <- function(data, group_name, export_path){
    # keep only this taxon
  group_data <- subset(data, group == group_name)
  
  # collapse by this group - also collapse all maturity stages.
  # we may not want to do this in the future but for now it's okay
  group_data %>%
    group_by(across(c(-genus_species, -count, -sum_of_density_number_m3))) %>%
    summarise(total_sum_of_density_number_m3 = sum(sum_of_density_number_m3)) -> group_data

  write.csv(group_data, export_path, row.names = FALSE)
}

export_group_data(data = bongo_catch_LH_collapse, group_name = "Cancer crab larvae",
                  export_path = here::here("model_inputs", "jsoes_bongo_cancer_crab_larvae.csv"))

export_group_data(data = bongo_catch_LH_collapse, group_name = "Non-Cancer crab larvae",
                  export_path = here::here("model_inputs", "jsoes_bongo_non_cancer_crab_larvae.csv"))

export_group_data(data = bongo_catch_LH_collapse, group_name = "shrimp larvae",
                  export_path = here::here("model_inputs", "jsoes_bongo_shrimp_larvae.csv"))

export_group_data(data = bongo_catch_LH_collapse, group_name = "Hyperiid amphipod",
                  export_path = here::here("model_inputs", "jsoes_bongo_hyperiid_amphipod.csv"))
```



