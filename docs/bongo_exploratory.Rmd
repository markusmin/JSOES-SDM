---
title: "JSOES Bongo Data Exploratory Analysis"
author: "Markus Min"
date: "`r Sys.Date()`"
output:
  html_document
---
```{r, echo = FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

This page contains exploratory analysis for the Bongo net data from JSOES.

- What is the variance of top taxa
- Spatial autocorrelation
- Temporal autocorrelation


#### Dataset description


#### Exploratory analysis

```{r load_libraries_data}
library(readxl)
library(here)
library(janitor)
library(tidyverse)
library(kableExtra)
bongo <- clean_names(read_excel(here::here("Data", "Markus_Min_Plankton Density for Trophic Summary Query_10.11.24.xlsx")))

trophic_groupings <- clean_names(read_excel(here::here("Data", "Markus_Min_Trophic Groupings_10.2.24.xlsx")))

# change genus species to be consistent across these two files, and usual 
# latin name and common name capitalization
bongo$genus_species <- str_to_sentence(bongo$genus_species)
trophic_groupings$genus_species <- str_to_sentence(trophic_groupings$genus_species)
trophic_groupings$common_name <- str_to_title(trophic_groupings$common_name)

trophic_groupings %>% 
  dplyr::select(genus_species, common_name) %>% 
  filter(!(duplicated(genus_species))) -> common_name_df

# get all unique tows
bongo %>% 
  mutate(sampleID = paste0(station, "_", sample_date)) %>% 
  relocate(sampleID) %>% 
  dplyr::select(-c(genus_species, life_history_stage, id_code, count, sum_of_density_number_m3)) %>% 
  filter(!(duplicated(sampleID))) -> bongo_tows

# complete bongo data, so that we have zeros for each taxon in tows where they weren't caught
bongo %>% 
  mutate(sampleID = paste0(station, "_", sample_date)) %>% 
  relocate(sampleID) %>% 
  # drop tow information; we will add this back later
  dplyr::select(-c(id_code, cruise_number, month, year, station_code, net_type, sample_date,
           sample_time, dec_lat, dec_long, station_depth_m, transect_name, station_number, 
           station, n_cr_s, day_night, volume_filtered_m3)) %>% 
  complete(sampleID, 
           nesting(genus_species, life_history_stage), 
           fill = list(count = 0, sum_of_density_number_m3 = 0)) -> bongo_catch

bongo_catch %>% 
  left_join(bongo_tows, by = "sampleID") -> bongo_catch





# add common name
bongo_catch %>% left_join(common_name_df, by = "genus_species") -> bongo_catch

# create a version of this where we collapse all life history stages together
bongo_catch %>% 
  dplyr::select(sampleID, genus_species, count, sum_of_density_number_m3) %>% 
  group_by(sampleID, genus_species) %>% 
  summarise_if(is.numeric, sum) -> bongo_catch_LH_collapse

bongo_catch_LH_collapse %>% 
  left_join(bongo_tows, by = "sampleID") %>% 
  ungroup() -> bongo_catch_LH_collapse
```

```{r load_spatial_data}
#### Spatial data ####
usa_spdf <- st_read("/Users/markusmin/Documents/ESA_RF_2021/map_files/USA_adm0.shp")
# load BC
CAN_spdf <- st_read("/Users/markusmin/Documents/ESA_RF_2021/map_files/canada/lpr_000b16a_e.shp")
BC_spdf <- filter(CAN_spdf, PRENAME == "British Columbia")
BC_proj <- st_transform(BC_spdf, crs = 4326)


# crop them to our desired area
US_west_coast <- sf::st_crop(usa_spdf,
    c(xmin = -126, ymin = 44, xmax = -123, ymax = 48.5))

BC_coast <- sf::st_crop(BC_proj,
    c(xmin = -126, ymin = 44, xmax = -123, ymax = 48.5))



# convert both shapefiles to a different projection (UTM zone 10) so that they can be plotted with the sdmTMB output
UTM_zone_10_crs <- 32610

US_west_coast_proj <- sf::st_transform(US_west_coast, crs = UTM_zone_10_crs)
BC_coast_proj <- sf::st_transform(BC_coast, crs = UTM_zone_10_crs)

# make this projection into kilometers
US_west_coast_proj_km <- st_as_sf(US_west_coast_proj$geometry/1000, crs = UTM_zone_10_crs)
BC_coast_proj_km <- st_as_sf(BC_coast_proj$geometry/1000, crs = UTM_zone_10_crs)
```



```{r common_taxa}
## total density
bongo_catch %>% 
  group_by(genus_species) %>% 
  summarise(total_density = sum(sum_of_density_number_m3)) %>% 
  arrange(desc(total_density)) %>% 
  left_join(common_name_df, by = "genus_species") %>% 
  relocate(common_name, .after = "genus_species") -> bongo_catch_density_sums

bongo_catch_density_sums[1:10,] %>% 
  mutate(total_density = round(total_density, 0)) %>% 
  kbl(caption = "Top ten taxa by sum of density.") %>% 
  kable_styling(latex_options = "HOLD_position")

## frequency of occurrence

# get count of each genus_species
bongo_catch_LH_collapse %>% 
  count(genus_species) %>% 
  arrange(desc(n)) %>% 
  mutate(prop_samples = n/nrow(bongo_tows)) %>% 
  left_join(common_name_df, by = "genus_species") %>% 
  relocate(common_name, .after = "genus_species") -> bongo_freq_occ

bongo_freq_occ[1:10, c("genus_species", "common_name", "prop_samples")] %>% 
  mutate(prop_samples = round(prop_samples, 2)) %>% 
  kbl(caption = "Top ten taxa by frequency of occurrence.") %>% 
  kable_styling(latex_options = "HOLD_position")

```

```{r sampling_resolution}

# temporal
# it's every year, June only
ggplot(bongo_tows, aes(x = sample_date)) +
  geom_bar()



```

##### Distributional maps

```{r create_basemap}
# create base map
survey_area_basemap_km <- ggplot(US_west_coast_proj_km) +
  geom_sf() +
  geom_sf(data = BC_coast_proj_km) +
  # coord_sf(ylim = c(4922.052, 5342.052), xlim = c(334.8638, 404.8638)) +
  # coord_sf(ylim = c(44,48.5),  xlim = c(-126, -123)) +
  ylab("Latitude")+
  xlab("Longitude")+
  theme(plot.background = element_rect(fill = "white"),
        panel.background = element_rect(fill="white", color = "black"),
        panel.border = element_rect(colour = "black", fill=NA, size=1),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = c(0.14, 0.2),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12),
        axis.ticks = element_blank(),
        axis.text = element_blank())
  # temporary fix for lat/long on axes to just get rid of them - start here to actually fix: https://forum.posit.co/t/converting-axes-to-lat-lon/27181

survey_area_basemap_km

survey_area_basemap <- ggplot(US_west_coast) +
  geom_sf() +
  geom_sf(data = BC_coast) +
  coord_sf(ylim = c(44,48.5),  xlim = c(-126, -123)) +
  scale_x_continuous(breaks = c(124,125,126)) +
  ylab("Latitude")+
  xlab("Longitude")+
  theme(plot.background = element_rect(fill = "white"),
        panel.background = element_rect(fill="white", color = "black"),
        panel.border = element_rect(colour = "black", fill=NA, size=1),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = c(0.14, 0.2),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12))
```


```{r plot-taxon-distribution}
plot_distribution <- function(data, taxon_name){
  # create facet_wrap plot for distribution across all years
  data %>% 
    mutate(encounter = ifelse(sum_of_density_number_m3 == 0, "zero", "non-zero")) -> data
  
  survey_area_basemap +
      geom_point(data = data, aes(x = dec_long, y = dec_lat, size = sum_of_density_number_m3, color = encounter),
                 alpha = 0.5) +
    scale_color_manual(values = c("zero" = "#fc9272", "non-zero" = "#2ca25f")) +
    facet_wrap(~year, nrow = 3) +
    ggtitle(taxon_name) +
    theme(legend.position = c(0.9, 0.15)) -> species_distribution_plot
  
  return(species_distribution_plot)
}
```


#### Warm-water vs. cold-water copepods

In the JSOES Bongo data *Calanus marshallae* is the most abundant cold-water copepod and *Calanus pacificus* is the most abundant warm-water coepod.

```{r map_calanus}
cama_dist_plot <- plot_distribution(data = subset(bongo_catch_LH_collapse, genus_species == "Calanus marshallae"),
                                    taxon_name = "Calanus marshallae")


ggsave(here::here("docs", "figures", "jsoes_bongo_exploratory", "cama_dist_plot.png"), plot = cama_dist_plot, height = 12, width = 17)


capa_dist_plot <- plot_distribution(data = subset(bongo_catch_LH_collapse, genus_species == "Calanus pacificus"),
                                    taxon_name = "Calanus pacificus")


ggsave(here::here("docs", "figures", "jsoes_bongo_exploratory", "capa_dist_plot.png"), plot = capa_dist_plot, height = 12, width = 17)

```

By taking the mean log density across the survey region, we can also create a crude index of abundance.

```{r calanus_time_series}
create_time_series <- function(data, taxon){
  data %>% 
    mutate(log_density = log(sum_of_density_number_m3 + 1)) %>% 
    group_by(year) %>% 
    summarise(mean_density = mean(log_density),
              sd_density = sd(log_density)) %>% 
    # mutate(CI_95_upper = mean_density + 1.96*sd_density) %>% 
    # mutate(CI_95_lower = mean_density - 1.96*sd_density) %>% 
    mutate(taxon = taxon) -> ts
  
  return(ts)
}

create_time_series(data = subset(bongo_catch_LH_collapse, genus_species == "Calanus marshallae"),
                                 taxon = "Calanus marshallae") -> cama_ts
create_time_series(data = subset(bongo_catch_LH_collapse, genus_species == "Calanus pacificus"),
                   taxon = "Calanus pacificus") -> capa_ts

cama_ts %>% 
  bind_rows(., capa_ts) -> calanus_ts

ggplot(calanus_ts, aes(x = year, y = mean_density, color = taxon)) +
  geom_point() +
  geom_line() +
  ylab("Mean log (density/m3 + 1)") +
  scale_color_manual(values = c("Calanus marshallae" = "#67a9cf", "Calanus pacificus" = "#b2182b"))


```




